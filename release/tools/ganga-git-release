#!/usr/bin/env python

import os
import os.path
import sys
import time
import re
import shutil
import argparse
import glob

parser = argparse.ArgumentParser(description='interactive release making tool')
parser.add_argument('version', help='Release version')
args = parser.parse_args()

version = args.version

CONFIG = {}
CONFIG['top'] = '/afs/cern.ch/sw/ganga'

CONFIG['version'] = version
CONFIG['version-pre'] = version + '-pre'
CONFIG['prereldir'] = os.path.join(CONFIG['top'], 'install', CONFIG['version-pre'])
CONFIG['reldir'] = os.path.join(CONFIG['top'], 'install', CONFIG['version'])
CONFIG['installdir'] = os.path.join(CONFIG['top'], 'install')
CONFIG['toolsdir'] = os.path.dirname(os.path.realpath(__file__))

CONFIG['webdir_top'] = os.path.join(CONFIG['top'], 'www')
CONFIG['tagsdir_top'] = os.path.join(CONFIG['webdir_top'], 'developers', 'tags')
CONFIG['tagsdir'] = os.path.join(CONFIG['top'], 'www', 'developers', 'tags', 'data', CONFIG['version'])

CONFIG['releasenotesdir'] = os.path.join(CONFIG['toolsdir'], '..')

CONFIG['tag'] = "Ganga-" + version.replace('.', '-')

# accounts used for CERN deployment of Ganga
GANGA_ACCOUNTS = [('Ganga', 'gangage'), ('GangaLHCb', 'gangalb'), ('GangaAtlas', 'gangaat')]

# running tests on different accounts
GANGA_ACCOUNT_TEST = [('gangage', 'test_ganga_generic'), ('gangaat', 'test_ganga_atlas'), ('gangalb', 'test_ganga_lhcb')]

# generation manuals
GANGA_ACCOUNT_MANUAL = {'gangage': 'generate_generic_manual', 'gangaat': 'generate_atlas_manual', 'gangalb': 'generate_lhcb_manual'}


def askYesNo(msg):
    answer = raw_input(msg + ' [yes/NO] ')

    if answer.upper() == 'YES':
        return True

    return False


def acmd(cmdpath, ignore_errors=False):
    print 'doing:', cmdpath
    print
    if os.system(cmdpath):
        if not ignore_errors:
            print "problem with executing: ", cmdpath
            sys.exit(1)


def toolcmd(cmd):
    if CONFIG['toolsdir']:
        cmdpath = "%s/%s"  % (CONFIG['toolsdir'], cmd)
    else:
        cmdpath = cmd
    acmd(cmdpath)


def remove_prerelease(prereleaseDir):

    acmd('rm -rf %s ' % prereleaseDir)

    prerel_basename = os.path.basename(prereleaseDir)   

    # remove the tarball also
    pre_tarball = '%s/tarball/Ganga-%s.tar.gz' % (CONFIG['top'], prerel_basename)
    try:
        os.unlink(pre_tarball)
        print 'sucessfully removed pre-release tarball %s' % pre_tarball
    except OSError as e:
        print 'Cannot delete pre-release tarball: %s' % str(e)  


def get_count_releases(installDir):

    currentDir = os.getcwd()

    os.chdir(installDir)

    def isRelease(x):
        return x[1] == '.' and x[3] == '.'

    dirs = [d for d in os.listdir(installDir) if isRelease(d)]

    os.chdir(currentDir)   

    return len(dirs)


def remove_oldest_prereleases(installDir):

    currentDir = os.getcwd()    

    os.chdir(installDir)

    dirs = (d for d in os.listdir(installDir) if '-pre' in d)
    dirs = [os.path.join(installDir, d) for d in dirs] # add path to each dir
    dirs.sort(lambda x, y: cmp(os.path.getmtime(x), os.path.getmtime(y)))

    num_prereleases = len(dirs)

    if num_prereleases == 0:
        os.chdir(currentDir)
        return False

    elif num_prereleases == 1:
        print 'Removing oldest prereleases to free space in the install directory' 

        remove_prerelease(dirs[0])

    else:
        print 'Removing oldest prereleases to free space in the install directory'

        remove_prerelease(dirs[0])
        remove_prerelease(dirs[1])

    os.chdir(currentDir)
    return True


def get_rel_manager_email():

    with open('%(tagsdir_top)s/release_manager.php' % CONFIG, 'r') as f:
        content = f.read()
        content = content.strip()

    leftIndex = content.find('"')
    rightIndex = content.rfind('"')

    relManagerEmail = content[leftIndex + 1:rightIndex]

    return relManagerEmail


def wait_all_tests_to_finish(outputdir):

    startTime = int(time.time())

    latestDir = os.path.dirname(outputdir)

    filesToSearch = [pkg + '.test.ALL__localxml.xml' for pkg in ['Ganga', 'GangaAtlas', 'GangaLHCb', 'GangaPanda', 'GangaRobot']]

    currentDir = os.getcwd()

    os.chdir(latestDir)

    while True:

        files = filter(os.path.isfile, os.listdir(latestDir))

        matchingFiles = []

        for f in files:

            fullFileName = os.path.join(latestDir,f)

            #if it is one of the files we search and is a new file
            if f in filesToSearch and os.path.getmtime(fullFileName) > startTime:

                matchingFiles.append(f)


        if len(matchingFiles) == len(filesToSearch):
            break

        time.sleep(60)

    rel_manager_email = get_rel_manager_email()

    os.chdir(currentDir)

    send_mail('testsfinished', receiver=rel_manager_email)

    print 'Email sent to release manager'


def send_mail(key, receiver=''):
    import smtplib
    import email

    releaseToolsDir = os.path.dirname(os.path.abspath(__file__))

    sender = 'project-ganga-developers@cern.ch'
    receivers = ''
    email_file = ''
    subject = ''

    if key == 'prerelease':

        email_file = os.path.join(releaseToolsDir, 'release_tool_emails/prerelease.txt')
        receivers = 'project-ganga-developers@cern.ch'
        subject = 'Ganga %s-pre is ready' % CONFIG['version']

    elif key == 'release':

        email_file = os.path.join(releaseToolsDir, 'release_tool_emails/release.txt')
        receivers = 'project-ganga-developers@cern.ch;project-ganga@cern.ch'
        subject = 'Ganga release %s is ready' % CONFIG['version']
   
    elif key == 'testsfinished':

        email_file = os.path.join(releaseToolsDir, 'release_tool_emails/testsfinished.txt')
        receivers = receiver
        subject = 'Ganga tests for %s-pre are finished' % CONFIG['version']        
        
    elif key == 'testreports':

        email_file = os.path.join(releaseToolsDir, 'release_tool_emails/testreports.txt')
        receivers = 'project-ganga-developers@cern.ch'
        subject = 'Ganga %s-pre test reports are ready' % CONFIG['version']    

    with open(email_file, 'rb') as fp:
        msg_string = fp.read()

    msg = email.message_from_string(msg_string)

    msg['Subject'] = subject
    msg['From'] = sender
    msg['To'] = receivers

    string_message = msg.as_string()
        
    if key == 'prerelease' or key == 'testreports':
        string_message = string_message.replace('VER', CONFIG['version'])
    elif key == 'release':
        string_message = string_message.replace('*version*', CONFIG['version'])
    elif key == 'testsfinished':
        string_message = string_message.replace('VER', CONFIG['version'])

    try:
        smtpObj = smtplib.SMTP('cernmx.cern.ch')
        smtpObj.sendmail(sender, receivers, string_message)

    except smtplib.SMTPException:
        print "Can not send %s notification email" % key


def PrereleaseCommand():
    """PRE: create the PRE-RELEASE in the prereldir"""
    if os.path.isdir(CONFIG['prereldir']):
        print 'the current prerelease is %(prereldir)s' % CONFIG
        prm = re.compile('(\S)+-pre(?P<num>\d+)')
        maxnum = 0
        for pre_rel in glob.glob(CONFIG['prereldir']+'*'):
            print 'prelease found:', pre_rel
            r = prm.match(os.path.split(pre_rel)[-1])
            if r:
                maxnum = max(maxnum,int(r.group('num')))
        maxnum += 1
        new_backup_prerelease = CONFIG['prereldir']+str(maxnum)
        #print 'if you answer YES then the current prerelease will be backed up as',new_backup_prerelease
        if askYesNo('do you want to delete the current prerelease (and back it up as %s)?' % new_backup_prerelease):
            acmd('mv %s %s' % (CONFIG['prereldir'],new_backup_prerelease))
            print 'sucessfully moved %s to %s' % (CONFIG['prereldir'], new_backup_prerelease)
            pre_tarball = '%(top)s/tarball/Ganga-%(version-pre)s.tar.gz' % CONFIG
            try:
                os.unlink(pre_tarball)
                print 'sucessfully removed pre-release tarball %s' % pre_tarball
            except OSError as e:
                print 'Cannot delete pre-release tarball: %s' % str(e)
        else:
            print "Cannot continue...Terminating"
            return

    #if there are a lot of releases we should clean some disk space
    if get_count_releases(CONFIG['installdir']) > 199:
        if not remove_oldest_prereleases(CONFIG['installdir']):
            print "There is not enough disk space for creation of the prerelease, please remove some of the oldest releases in %s" % CONFIG['installdir']
            return

    print 'Making pre-release tarballs (forcing recreation) for slc4_ia32_gcc34 (limited externaldependencies)'

    toolcmd('ganga-git-create-pre %(version)s'%CONFIG)

    print 'the prerelease is installed in',CONFIG['prereldir']

    versionfile = os.path.join(CONFIG['webdir_top'],'download','VERSIONS.txt')
    print 'Updating file with available releases'
    acmd("touch %s && date +'%s - %%d %%b %%Y %%k:%%m:%%S' >> %s"% (versionfile, CONFIG['version-pre'], versionfile))

    if askYesNo('Do you want to send email to Ganga developers list that the prerelease is ready?'):
        send_mail('prerelease')


def PretestCommand():
    """TEST: run the test suite in the pre-release prereldir"""
    if not os.path.isdir(CONFIG['prereldir']):
        print "can't find the prerelease in ", CONFIG['prereldir']
        return

    outputdir = '%(prereldir)s/reports/latest/output' % CONFIG

    try:
        os.makedirs(outputdir)
    except Exception as e:
        print 'WARNING: ', str(e)

    for account, test_name in GANGA_ACCOUNT_TEST:
        print '*' * 40
        print 'Login to %s@lxplus and run : sh ~/test/%s.sh %s' % (account, test_name, version.replace('.', ' '))

    print '*' * 40
    print "Now wait for tests to complete, a notification email will be sent to the release manager when all tests are finished."

    wait_all_tests_to_finish(outputdir)


def TestReportCommand():
    """TEST REPORT: Create the summary web pages with the test results."""

    print "Creating web pages."
    acmd("%(prereldir)s/bin/ganga --test -o\'[TestingFramework]ReleaseTesting=True\' -o\'EnableHTMLReporter=True\' -o\'EnableTestRunner=False\'" % CONFIG)

    if askYesNo('Do you want to send email to Ganga developers list that test reports are ready?'):
        send_mail('testreports')


def ReleaseCommand():
    """RELEASE: make a release based on a previously created GLOBAL TAG and create the distribution kits"""
    if os.path.isdir(CONFIG['reldir']):
        print 'release already exists in',CONFIG['reldir']
        return

    #if there are a lot of releases we should clean some disk space
    if get_count_releases(CONFIG['installdir']) > 199:
        if not remove_oldest_prereleases(CONFIG['installdir']):
            print "There is not enough disk space for creation of the prerelease, please remove some of the oldest releases in %s" % CONFIG['installdir']
            return

    print 'Making installation tarballs'

    toolcmd('ganga-git-create-final %(version)s' % CONFIG)

    print 'Byte-compiling sources'

    toolcmd('prepdist %(reldir)s compile' % CONFIG)

    print 'Copying all reports from the pre-release area'

    acmd('cp -r %(prereldir)s/reports %(reldir)s' % CONFIG)

    print 'Regenerating reports'

    toolcmd('ganga-release-html %(version)s %(reldir)s' % CONFIG)

    print 'Cleaning any junk left by report generation scripts'

    toolcmd('prepdist %(reldir)s clean' % CONFIG)

    #print 'Fix the coverage report symlink'

    #acmd('ln -s ../latest/html/coverage %(reldir)s/reports/html/coverage' % CONFIG)

    print 'Protecting the release area'

    toolcmd('acl protect %(reldir)s' % CONFIG)

    print 'Protecting the tags dir'
    _protectTagsDir()

    print 'Updating web pages'
    _updateWebPages()

    print 'Release sucesfully made in the %(reldir)s' % CONFIG

    if askYesNo('Do you want to send email to Ganga developers and Ganga project lists that the release is ready?'):
        send_mail('release')


def _protectTagsDir():
    """
    write protect the tags directory
    """
    toolcmd('acl protect %(tagsdir)s' % CONFIG)

    with open('%(tagsdir_top)s/open_releases' % CONFIG, 'r') as fh:
        next_releases = [line.strip() for line in fh.readlines() if line.strip() != CONFIG['version']]

    with open('%(tagsdir_top)s/open_releases' % CONFIG, 'w') as fh:
        fh.writelines([release + '\n' for release in next_releases])


def _updateWebPages():
    """
    For each file (e.g mypage.html) that needs to be updated automatically at release time
    one should write a template file (.tpl extension) for it (i.e. mypage.html.tpl)
    Current keywords:
        <:GANGA_VERSION:> : the latest production release
        <:GANGA_DATE:>    : the release date of the latest vrsion
        <:GANGA_ALL_VERSIONS:>: comma separated list of all existing versions of Ganga in release area
    """
    import urllib
    # we do not expose development releases to public
    if re.compile('(beta|alpha|pre)').search(CONFIG['version']):
        print 'DEVELOPMENT release detected. The web pages/NEWS are not generated!'
        return

    # the list of directories in web area to search for templates
    dirs = ['%(webdir_top)s/user/' % CONFIG,
            '%(webdir_top)s/download/' % CONFIG,
            '%(webdir_top)s/include/' % CONFIG,
            '%(webdir_top)s/rss/' % CONFIG,
            '%(webdir_top)s/developers/tags'%CONFIG,
            '%(installdir)s' % CONFIG
           ]

    #get production releases from ganga_setup
    import ganga_setup
    p,a = ganga_setup.get_versions(CONFIG['installdir'])
    publicVersStr = ",".join(['"%s"'% r for r in p])
    devVersStr = ",".join(['"%s"'% r for r in a if r not in p])
    #replacements dictionary : KEYWORD -> (REPLACEMENT, append?)
    # append : False - replace the KEYWORD in the destination file
    #        : True  - replace the KEYWORD in the template file and add a new KEYWORD before the replacement and then copy the template to destination file
    #CONFIG['release_date'] = time.strftime('%d %B %Y',time.gmtime())
    CONFIG['release_date'] = time.strftime('%a, %d %b %Y %H:%M:%S +0000', time.gmtime())
    cleanGuid = urllib.quote('release-' + str(CONFIG['version']) + '-' + time.strftime('%s', time.gmtime()))
    replacements = {'<!--GANGA_VERSION-->'     : (CONFIG['version'], False),
                    '<!--GANGA_DATE-->'        : (CONFIG['release_date'], False),
                    '<!--GANGA_PUB_VERSIONS-->': (publicVersStr, False),
                    '<!--GANGA_DEV_VERSIONS-->': (devVersStr, False),
                    '<!--GANGA_RSS_ALERT-->'   : ("<item>"\
                                                 "<title>Ganga %(version)s is available</title>"\
                                                 "<description>%(release_date)s: public release %(version)s is available ! Check the release page for further information.</description>"\
                                                 "<link>http://ganga.web.cern.ch/ganga/release/%(version)s/reports/html/Release.html</link>"\
                                                 "<pubDate>%(release_date)s</pubDate>"\
                                                 "<guid isPermaLink='false'>" % CONFIG + cleanGuid + "</guid>"\
                                                 "<author>project-ganga@cern.ch (Ganga Mailing List)</author>"
                                                 "</item>", True)
                   }

    templates=[]
    for dir in dirs:
        templates.extend(glob.glob('%s/*.tpl' % dir))

    # replace the keywords in .tpl files:
    for template in templates:
        newfile = os.path.splitext(template)[0]
        try:
            print 'Writting %s '% newfile
            tf  = file(template, 'r')
            ntf = file('%s.new' % template, 'w')
            nf  = file(newfile, 'w')
            try:
                for line in tf:
                    #keep a copy to generate new template line
                    tline = line
                    for keyword in replacements:
                        repl,append = replacements[keyword]
                        #replace the keyword
                        line = line.replace(keyword,repl)
                        #replace the keyword but keep the keyword in template file
                        # (in this way we keep reaplacing this keyword next time we regenerate)
                        if append:
                            tline = tline.replace(keyword,'%s %s'%(keyword,repl))
                    nf.write(line)
                    ntf.write(tline)
            finally:
                tf.close()
                ntf.close()
                nf.close()
            #replace the template file (it might be modified by append rules before)
            shutil.move('%s.new' % template, template)
        except Exception,e:
            print 'Warning! Cannot write %s. %s' % (newfile,str(e))


def GenerateManuals():
    """GENERATE LHCB MANUAL: generate LHCb reference manuals"""

    for x in GANGA_ACCOUNTS:
        if not x[0] in ['GangaLHCb']:
            continue


        print 'login to %s@lxplus and run this command:'%x[1]
        print 'sh ~/test/%s.sh %s'%(GANGA_ACCOUNT_MANUAL[x[1]], version.replace('.',' '))
        print

    raw_input("When you have executed the command, press Enter to continue ...")


def ChangeReleaseManager():
    """CHANGE RELEASE MANAGER: change the email address of the release manager"""
    current_release_mgr=raw_input('Enter release manager email or just ENTER to keep the current release manager email:')
    if current_release_mgr:
        with open('%(tagsdir_top)s/release_manager.php' % CONFIG, 'w') as fh:
            fh.write('<?php $release_manager_email="'+current_release_mgr+'";?>')


def QuitCommand():
    """Quit"""
    sys.exit(0)


def ShowConfig():
    """Show current configuration"""
    print "CONFIGURATION:"
    for c in CONFIG:
        print "  %-10s = %s" % (c,CONFIG[c])


def _setlib():
    """
    Add the script directory to python path
    """
    libdir = os.path.normpath(os.path.dirname(__file__))
    if libdir not in sys.path:
        sys.path.insert(0, libdir)

_setlib()

commands = [ShowConfig, PrereleaseCommand, PretestCommand, TestReportCommand, ReleaseCommand, GenerateManuals, ChangeReleaseManager, QuitCommand]

ShowConfig()

while True:
    print
    print "COMMANDS:"
    for i, command in enumerate(commands):
        print "  %d   - %s" % (i, command.__doc__)
    print
    c = raw_input('Enter your choice: ')
    commands[int(c)]()
